apiVersion: apps/v1
kind: Deployment
metadata:
  name: identity-provider
  namespace: cafeteria
spec:
  replicas: 2
  selector:
    matchLabels:
      app: identity-provider
  template:
    metadata:
      labels:
        app: identity-provider
      # ADDED: Prometheus scraping annotations
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "4001"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: identity-provider
          image: identity-provider:latest
          ports:
            - containerPort: 4001
          env:
            - name: PORT
              value: "4001"
            - name: DB_HOST
              value: postgres-auth # CHANGED: Ensure this points to your specific Auth DB service
            - name: DB_PORT
              value: "5432"
            - name: DB_NAME
              value: cafeteria_auth
            - name: DB_USER
              value: postgres
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: password
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
            - name: JWT_EXPIRY
              value: "24h"
          livenessProbe:
            httpGet:
              path: /health
              port: 4001
            initialDelaySeconds: 30
            periodSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  name: identity-provider
  namespace: cafeteria
spec:
  selector:
    app: identity-provider
  ports:
    - port: 4001
      targetPort: 4001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stock-service
  namespace: cafeteria
spec:
  replicas: 2
  selector:
    matchLabels:
      app: stock-service
  template:
    metadata:
      labels:
        app: stock-service
      # ADDED: Prometheus scraping annotations
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "4002"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: stock-service
          image: stock-service:latest
          ports:
            - containerPort: 4002
          env:
            - name: PORT
              value: "4002"
            - name: DB_HOST
              value: postgres-inventory # CHANGED: Point to the inventory DB
            - name: DB_PORT
              value: "5432"
            - name: DB_NAME
              value: cafeteria_inventory
            - name: DB_USER
              value: postgres
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: password
            # ADDED: Stock Service must publish to the Kitchen Queue
            - name: RABBITMQ_URL
              value: "amqp://guest:guest@rabbitmq:5672"
          livenessProbe:
            httpGet:
              path: /health
              port: 4002
            initialDelaySeconds: 20
            periodSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  name: stock-service
  namespace: cafeteria
spec:
  selector:
    app: stock-service
  ports:
    - port: 4002
      targetPort: 4002
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kitchen-service
  namespace: cafeteria
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kitchen-service
  template:
    metadata:
      labels:
        app: kitchen-service
      # ADDED: Prometheus scraping annotations
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "4003"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: kitchen-service
          image: kitchen-service:latest
          ports:
            - containerPort: 4003
          envFrom:
            - configMapRef:
                name: app-config
          env:
            - name: PORT
              value: "4003"
            # ADDED: Kitchen Service must consume from the Kitchen Queue
            - name: RABBITMQ_URL
              value: "amqp://guest:guest@rabbitmq:5672"
            # ADDED: Needs to trigger updates to the Notification Hub
            - name: NOTIFICATION_HUB_URL
              value: "http://notification-hub:4005"
          livenessProbe:
            httpGet:
              path: /health
              port: 4003
            initialDelaySeconds: 30
            periodSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  name: kitchen-service
  namespace: cafeteria
spec:
  selector:
    app: kitchen-service
  ports:
    - port: 4003
      targetPort: 4003
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-hub
  namespace: cafeteria
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notification-hub
  template:
    metadata:
      labels:
        app: notification-hub
      # ADDED: Prometheus scraping annotations
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "4005"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: notification-hub
          image: notification-hub:latest
          ports:
            - containerPort: 4005
          env:
            - name: PORT
              value: "4005"
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
          livenessProbe:
            httpGet:
              path: /health
              port: 4005
            initialDelaySeconds: 15
            periodSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  name: notification-hub
  namespace: cafeteria
spec:
  selector:
    app: notification-hub
  ports:
    - port: 4005
      targetPort: 4005
